<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kasam Sales Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      html { 
        font-size: 75.5%;
      } 
      body { 
        font-family: 'Inter', sans-serif; 
        background-color: #f3f4f6;
      }
      .kpi-card { 
        transition: all 0.3s ease; 
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); 
      }
      .kpi-card:hover { 
        transform: translateY(-5px); 
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); 
      }
      /* Sidebar Styles - UPDATED FOR STICKY POSITIONING */
      .sidebar-wrapper {
        position: fixed; /* Keep fixed for mobile slide-in */
        top: 0;
        left: 0;
        height: 100%;
        z-index: 40;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
      }
      .sidebar-wrapper.is-open {
        transform: translateX(0);
      }
      .sidebar-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 30;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out;
      }
      .sidebar-wrapper.is-open + .sidebar-overlay {
        opacity: 1;
        visibility: visible;
      }
      @media (min-width: 1024px) { /* lg breakpoint */
        /* Change to sticky for larger screens to allow scrolling with content */
        .sidebar-wrapper {
            position: sticky;
            top: 3px; /* <--- CHANGED: Increased the top offset to move it further down */
            height: calc(100vh - 6px); /* <--- CHANGED: Adjusted height to account for the larger top and bottom gap (40px top + 40px bottom) */
            transform: translateX(0);
        }
        .sidebar-overlay {
            display: none;
        }
        #menu-button {
            display: none;
        }
      }
    </style>
</head>
<body class="antialiased text-slate-700">

    <div id="app-container" class="min-h-screen bg-gray-100">
        <div id="skeleton-loader" class="h-screen flex animate-pulse">
            <div class="w-52 bg-white p-4 flex-col space-y-6 border-r border-gray-200 flex-shrink-0 hidden lg:flex">
                <div class="h-10 bg-gray-200 rounded w-full mt-4"></div>
                <div class="h-px bg-gray-200"></div>
                <div class="space-y-4 pt-4">
                    <div class="h-8 bg-gray-200 rounded w-11/12"></div>
                    <div class="h-8 bg-gray-200 rounded w-11/12"></div>
                    <div class="h-8 bg-gray-200 rounded w-11/12"></div>
                </div>
            </div>
            <div class="flex-1 flex flex-col overflow-hidden bg-gray-100">
                <div class="h-20 bg-white shadow-md p-4 flex items-center justify-between border-b border-gray-200 flex-shrink-0">
                    <div class="h-12 bg-gray-200 rounded w-60"></div>
                </div>
                <main class="flex-1 overflow-x-hidden overflow-y-auto p-8 space-y-8">
                    <div class="flex flex-col items-center justify-center p-12 h-full w-full bg-white rounded-lg shadow">
                        <div class="h-60 w-60 bg-gray-200 rounded-full mb-8 opacity-50"></div>
                        <div class="h-10 bg-gray-300 rounded w-1/2 mb-4"></div>
                        <div class="w-full max-w-lg space-y-3">
                            <div class="h-4 bg-gray-200 rounded w-full"></div>
                            <div class="h-4 bg-gray-200 rounded w-11/12"></div>
                            <div class="h-4 bg-gray-200 rounded w-5/6 mx-auto"></div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <div id="app-content" class="hidden min-h-screen flex flex-col">
            <header class="bg-white shadow-md flex-shrink-0 z-30"> 
                <div class="px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-20">
                        <div class="flex items-center">
                            <button id="menu-button" class="lg:hidden p-2 -ml-4 mr-3 text-gray-500 hover:text-gray-900">
                                <i data-lucide="menu" class="w-6 h-6"></i>
                            </button>
                            <h1 class="hidden sm:block text-xl font-extrabold text-gray-800">Kasam Fashions Pvt.Ltd</h1>
                        </div>
                    </div>
                </div>
            </header>

            <div class="flex flex-1">
                <div id="sidebar-wrapper" class="sidebar-wrapper w-56 bg-white border-r border-gray-200 p-4 z-40 flex-shrink-0 lg:my-8 lg:rounded-lg"> <aside class="flex flex-col h-full">
                        <div class="flex items-center justify-between lg:hidden mb-4">
                            <span class="font-bold text-lg">Menu</span>
                            <button id="sidebar-close-button" class="p-1"><i data-lucide="x" class="w-6 h-6"></i></button>
                        </div>
                        <nav id="navigation" class="space-y-1 flex-grow">
                             <a href="#" data-page="home" class="nav-link flex items-center px-4 py-2.5 rounded-md font-medium bg-blue-100 text-blue-700"><i data-lucide="home" class="w-5 h-5 mr-3"></i>Home</a>
                             <a href="#" data-page="reports" class="nav-link flex items-center px-4 py-2.5 rounded-md font-medium text-gray-600 hover:bg-gray-100"><i data-lucide="file-text" class="w-5 h-5 mr-3"></i>Reports</a>
                             <a href="#" data-page="dashboard" class="nav-link flex items-center px-4 py-2.5 rounded-md font-medium text-gray-600 hover:bg-gray-100"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>Dashboard</a>
                        </nav>
                    </aside>
                </div>
                <div id="sidebar-overlay" class="sidebar-overlay"></div>
                
                <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto flex flex-col">
                    <div id="page-home" class="page-content flex-1 bg-white rounded-lg shadow flex flex-col items-center justify-start p-6 sm:p-12">
                        <img src="https://www.dropbox.com/scl/fi/qovbx5eogzklebun582ln/Sales.png?rlkey=x6pp38je3j7eclrrspl6xh3l7&st=f1ayft52&raw=1" alt="Kasam Sales Insights Logo" class="h-40 sm:h-50 w-auto mt-20 mb-4 object-contain opacity-100"/>
                        <h2 class="text-2xl sm:text-2xl font-bold text-gray-800 mb-4 text-center">Welcome to Kasam Sales Insights</h2>
                        <p class="text-base sm:text-lg text-gray-600 max-w-2xl text-center">Use the navigation panel to view reports, track sales trends, and analyze payment differences of the stores.</p>
                    </div>

                    <div id="page-reports" class="page-content hidden flex-1">
                        <div class="bg-white rounded-lg shadow h-full flex flex-col p-6 space-y-6">
                            <div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                                    <div class="relative" id="reports-location-filter-container">
                                        <label class="block text-sm font-medium text-gray-700">Location(s)</label>
                                        <button id="reports-location-button" class="mt-1 w-full border border-gray-300 rounded-md p-2 bg-white text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <span id="reports-location-text" class="truncate">Select Location(s)</span>
                                            <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
                                        </button>
                                        <div id="reports-location-dropdown" class="hidden absolute z-20 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto p-2 space-y-1"></div>
                                    </div>
                                    <div>
                                        <label for="reports-from-date" class="block text-sm font-medium text-gray-700">From Date</label>
                                        <input type="date" id="reports-from-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2" />
                                    </div>
                                    <div>
                                        <label for="reports-to-date" class="block text-sm font-medium text-gray-700">To Date</label>
                                        <input type="date" id="reports-to-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2" />
                                    </div>
                                    <button id="reports-search-button" class="w-full flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 h-10"><i data-lucide="search" class="w-4 h-4"></i><span>Search</span></button>
                                    <button id="reports-download-button" disabled class="w-full flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed h-10"><i data-lucide="download" class="w-4 h-4"></i><span>Download CSV</span></button>
                                </div>
                            </div>
                            <div id="reports-kpi-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-5"></div>
                            <div class="flex-1 overflow-hidden flex flex-col">
                                <div class="overflow-auto flex-1">
                                    <div id="reports-table-container" class="relative">
                                         <table class="min-w-full divide-y divide-gray-200">
                                            <thead id="reports-table-head" class="bg-gray-50 sticky top-0 z-10"></thead>
                                            <tbody id="reports-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                                        </table>
                                    </div>
                                     <div id="reports-no-data" class="hidden text-center py-16 px-4">
                                        <i data-lucide="search-x" class="mx-auto h-12 w-12 text-gray-400"></i>
                                        <h3 class="mt-2 text-sm font-medium text-gray-900">No Data Available</h3>
                                        <p class="mt-1 text-sm text-gray-500">There is no sales data for the selected criteria.</p>
                                    </div>
                                </div>
                                <div id="reports-pagination" class="hidden flex justify-between items-center px-4 py-3 border-t border-gray-200 bg-gray-50 flex-shrink-0"></div>
                            </div>
                        </div>
                    </div>

                    <div id="page-dashboard" class="page-content hidden flex-1">
                        <div class="bg-white rounded-lg shadow h-full flex flex-col p-6 space-y-6">
                            <div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                                    <div class="relative lg:col-span-1" id="dashboard-location-filter-container">
                                        <label class="block text-sm font-medium text-gray-700">Location(s)</label>
                                        <button id="dashboard-location-button" class="mt-1 w-full border border-gray-300 rounded-md p-2 bg-white text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-purple-500">
                                            <span id="dashboard-location-text" class="truncate">Select Location(s)</span>
                                            <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
                                        </button>
                                        <div id="dashboard-location-dropdown" class="hidden absolute z-20 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto p-2 space-y-1"></div>
                                    </div>
                                    <div>
                                        <label for="dashboard-from-date" class="block text-sm font-medium text-gray-700">From Date</label>
                                        <input type="date" id="dashboard-from-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm p-2" />
                                    </div>
                                    <div>
                                        <label for="dashboard-to-date" class="block text-sm font-medium text-gray-700">To Date</label>
                                        <input type="date" id="dashboard-to-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm p-2" />
                                    </div>
                                    <button id="dashboard-search-button" class="w-full flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-purple-600 rounded-md hover:bg-purple-700 h-10">
                                        <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                                        <span>Search Dashboard</span>
                                    </button>
                                </div>
                            </div>
                            <div id="dashboard-content-area" class="relative flex-1">
                                <div id="dashboard-initial-message" class="absolute inset-0 w-full h-full flex flex-col items-center justify-center bg-white rounded-lg">
                                    <i data-lucide="bar-chart-3" class="h-20 w-20 text-blue-400 mb-4"></i>
                                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Build Your Dashboard!</h2>
                                    <p class="text-gray-600 text-lg">Select filters and click 'Search Dashboard' to generate charts.</p>
                                </div>
                                <div id="dashboard-charts-container" class="hidden h-full flex flex-col space-y-6">
                                    <div id="dashboard-kpi-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1">
                                        <div class="bg-white p-6 rounded-lg shadow-inner border lg:col-span-1"><h3 class="text-lg font-semibold mb-4 text-gray-800">Payment Contribution</h3><div class="relative h-64 sm:h-72"><canvas id="payment-chart"></canvas></div></div>
                                        <div class="bg-white p-6 rounded-lg shadow-inner border lg:col-span-1"><h3 class="text-lg font-semibold mb-4 text-gray-800">Difference by Type</h3><div class="relative h-64 sm:h-72"><canvas id="difference-chart"></canvas></div></div>
                                        <div class="bg-white p-6 rounded-lg shadow-inner border lg:col-span-1"><h3 class="text-lg font-semibold mb-4 text-gray-800">No. of Bills per Day</h3><div class="relative h-64 sm:h-72"><canvas id="bills-chart"></canvas></div></div>
                                        <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-inner border">
                                            <h3 class="text-lg font-semibold mb-4 text-gray-800">Sales Trend</h3>
                                            <div class="relative h-96"><canvas id="sales-trend-chart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <div id="error-container" class="hidden min-h-screen items-center justify-center bg-red-50 text-red-800">
            <div class="text-center p-8 bg-white shadow-lg rounded-lg border border-red-200">
                <i data-lucide="alert-circle" class="mx-auto h-12 w-12 text-red-500"></i>
                <h2 class="mt-4 text-2xl font-bold">Failed to Load Data</h2>
                <p id="error-message" class="mt-2 text-base"></p>
                <p class="mt-4 text-sm text-gray-600">Please check your internet connection and ensure the data source is available. Try refreshing the page.</p>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // =========== CONFIG & STATE ===========
    const GOOGLE_SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbwVGCl3OP2_yBiumCfkbMk5Tygyyv6gyZ8REKqvvM3I0v7BsN5sce7OUlaxxRkEYnLR/exec';
    const ITEMS_PER_PAGE = 10;
    
    let salesData = [];
    let locations = [];
    let reportsFilteredData = [];
    let reportsCurrentPage = 1;
    let chartInstances = {};

    // =========== DOM ELEMENT SELECTORS ===========
    const skeletonLoader = document.getElementById('skeleton-loader');
    const appContent = document.getElementById('app-content');
    const errorContainer = document.getElementById('error-container');
    const errorMessage = document.getElementById('error-message');
    
    // Navigation
    const navigation = document.getElementById('navigation');
    const menuButton = document.getElementById('menu-button');
    const sidebarWrapper = document.getElementById('sidebar-wrapper');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const sidebarCloseButton = document.getElementById('sidebar-close-button');
    const pageContents = document.querySelectorAll('.page-content');

    // Reports Page
    const reportsLocationBtn = document.getElementById('reports-location-button');
    const reportsLocationTxt = document.getElementById('reports-location-text');
    const reportsLocationDropdown = document.getElementById('reports-location-dropdown');
    const reportsFromDate = document.getElementById('reports-from-date');
    const reportsToDate = document.getElementById('reports-to-date');
    const reportsSearchBtn = document.getElementById('reports-search-button');
    const reportsDownloadBtn = document.getElementById('reports-download-button');
    const reportsKpiGrid = document.getElementById('reports-kpi-grid');
    const reportsTableContainer = document.getElementById('reports-table-container');
    const reportsTableHead = document.getElementById('reports-table-head');
    const reportsTableBody = document.getElementById('reports-table-body');
    const reportsNoData = document.getElementById('reports-no-data');
    const reportsPagination = document.getElementById('reports-pagination');

    // Dashboard Page
    const dashboardLocationBtn = document.getElementById('dashboard-location-button');
    const dashboardLocationTxt = document.getElementById('dashboard-location-text');
    const dashboardLocationDropdown = document.getElementById('dashboard-location-dropdown');
    const dashboardFromDate = document.getElementById('dashboard-from-date');
    const dashboardToDate = document.getElementById('dashboard-to-date');
    const dashboardSearchBtn = document.getElementById('dashboard-search-button');
    const dashboardInitialMsg = document.getElementById('dashboard-initial-message');
    const dashboardChartsContainer = document.getElementById('dashboard-charts-container');
    const dashboardKpiGrid = document.getElementById('dashboard-kpi-grid');

    // =========== UTILITY FUNCTIONS ===========
    const parseNumber = (value) => parseFloat(String(value || '0').replace(/,/g, '')) || 0;
    const parseIntNumber = (value) => parseInt(String(value || '0').replace(/,/g, ''), 10) || 0;

    const parseSheetDate = (dateString) => {
        if (!dateString) return null;
        const parts = String(dateString).split(/[-/]/).map(p => p.trim());
        if (parts.length === 3) {
            let day, month, year;
            if (parts[0].length === 4) { [year, month, day] = parts; } 
            else { [day, month, year] = parts; }
            if (year.length === 2) year = '20' + year;
            const date = new Date(`${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
            date.setUTCHours(0,0,0,0);
            return date;
        }
        const parsed = new Date(dateString);
        if(isNaN(parsed.getTime())) return null;
        parsed.setUTCHours(0,0,0,0);
        return parsed;
    };
    
    const formatDate = (date) => {
        if (!(date instanceof Date)) date = parseSheetDate(date);
        if (!date || isNaN(date)) return '-';
        return `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;
    };

    // =========== DATA FETCHING & INITIALIZATION ===========
    async function initializeApp() {
        try {
            const response = await fetch(GOOGLE_SHEET_API_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const rawData = await response.json();
            
            salesData = rawData.map(item => ({
                store: item.store || '', date: item.date || '',
                posCash: parseNumber(item.posCash), depositedCash: parseNumber(item.depositedCash),
                expenses: parseNumber(item.expenses), cashDiff: parseNumber(item.cashDiff),
                posCard: parseNumber(item.posCard), cardSettled: parseNumber(item.cardSettled),
                cardDiff: parseNumber(item.cardDiff), posUpi: parseNumber(item.posUpi),
                upiSettled: parseNumber(item.upiSettled), upiDiff: parseNumber(item.upiDiff),
                overallDiff: parseNumber(item.overallDiff), remarks: item.remarks || '',
                billCount: parseIntNumber(item.billCount)
            }));
            
            locations = [...new Set(salesData.map(d => d.store))].filter(Boolean).sort();
            
            populateLocationFilters();
            addEventListeners();
            renderReports(); // Render initial empty state for reports page
            
            skeletonLoader.style.display = 'none';
            appContent.style.display = 'flex';
        } catch (err) {
            console.error("Initialization failed:", err);
            errorMessage.textContent = err.message;
            skeletonLoader.style.display = 'none';
            errorContainer.style.display = 'flex';
        } finally {
            lucide.createIcons();
        }
    }

    // =========== UI & NAVIGATION ===========
    function switchPage(pageId) {
        pageContents.forEach(p => p.classList.add('hidden'));
        document.getElementById(`page-${pageId}`).classList.remove('hidden');

        navigation.querySelectorAll('.nav-link').forEach(link => {
            if (link.dataset.page === pageId) {
                link.classList.add('bg-blue-100', 'text-blue-700');
                link.classList.remove('text-gray-600', 'hover:bg-gray-100');
            } else {
                link.classList.remove('bg-blue-100', 'text-blue-700');
                link.classList.add('text-gray-600', 'hover:bg-gray-100');
            }
        });
        sidebarWrapper.classList.remove('is-open');
    }
    
    function populateLocationFilters() {
        const dropdownHtml = locations.map(l => `
            <div class="flex items-center">
                <input id="loc-${l}" type="checkbox" value="${l}" data-type="reports" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label for="loc-${l}" class="ml-2 block text-sm text-gray-900 cursor-pointer">${l}</label>
            </div>
        `).join('');
        reportsLocationDropdown.innerHTML = dropdownHtml;

        const dashDropdownHtml = locations.map(l => `
            <div class="flex items-center">
                <input id="dash-loc-${l}" type="checkbox" value="${l}" data-type="dashboard" class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                <label for="dash-loc-${l}" class="ml-2 block text-sm text-gray-900 cursor-pointer">${l}</label>
            </div>
        `).join('');
        dashboardLocationDropdown.innerHTML = dashDropdownHtml;
    }
    
    function updateLocationButtonText(type) {
        const dropdown = type === 'reports' ? reportsLocationDropdown : dashboardLocationDropdown;
        const textEl = type === 'reports' ? reportsLocationTxt : dashboardLocationTxt;
        const selected = Array.from(dropdown.querySelectorAll('input:checked'));
        if (selected.length === 0) textEl.textContent = 'Select Location(s)';
        else if (selected.length === 1) textEl.textContent = selected[0].value;
        else textEl.textContent = `${selected.length} locations selected`;
    }

    // =========== FILTERING LOGIC ===========
    function getFilteredData(type) {
        const fromDateVal = type === 'reports' ? reportsFromDate.value : dashboardFromDate.value;
        const toDateVal = type === 'reports' ? reportsToDate.value : dashboardToDate.value;
        const dropdown = type === 'reports' ? reportsLocationDropdown : dashboardLocationDropdown;
        const selectedLocs = Array.from(dropdown.querySelectorAll('input:checked')).map(cb => cb.value);

        if (selectedLocs.length === 0 || !fromDateVal || !toDateVal) {
            alert("Please select at least one location, a 'From Date', and a 'To Date'.");
            return null;
        }

        const from = parseSheetDate(fromDateVal);
        const to = parseSheetDate(toDateVal);
        const lowercasedLocations = selectedLocs.map(l => l.trim().toLowerCase());

        return salesData.filter(d => {
            const itemDate = parseSheetDate(d.date);
            if (!itemDate || !d.store) return false;
            const locMatch = lowercasedLocations.includes(d.store.trim().toLowerCase());
            const dateMatch = itemDate >= from && itemDate <= to;
            return locMatch && dateMatch;
        });
    }

    // =========== REPORTS PAGE LOGIC ===========
    function handleReportsSearch() {
        const filtered = getFilteredData('reports');
        if (filtered) {
            reportsFilteredData = filtered;
            reportsCurrentPage = 1;
            renderReports();
        }
    }
    
    function renderReports() {
        if (reportsFilteredData.length === 0) {
            reportsKpiGrid.innerHTML = '';
            reportsTableContainer.classList.add('hidden');
            reportsPagination.classList.add('hidden');
            reportsNoData.classList.remove('hidden');
            reportsDownloadBtn.disabled = true;
            return;
        }

        reportsTableContainer.classList.remove('hidden');
        reportsNoData.classList.add('hidden');
        reportsDownloadBtn.disabled = false;
        
        const sum = (key) => reportsFilteredData.reduce((s, d) => s + (d[key] || 0), 0);
        
        // KPIs
        const totalPOSValue = sum('posCash') + sum('posCard') + sum('posUpi');
        const totalSettled = sum('depositedCash') + sum('cardSettled') + sum('upiSettled');
        const overallDifference = sum('overallDiff');
        const totalExpenses = sum('expenses');
        const totalCash = sum('posCash'), totalCard = sum('posCard'), totalUpi = sum('posUpi');
        const cashPerc = totalPOSValue ? ((totalCash / totalPOSValue) * 100).toFixed(1) : 0;
        const cardPerc = totalPOSValue ? ((totalCard / totalPOSValue) * 100).toFixed(1) : 0;
        const upiPerc  = totalPOSValue ? ((totalUpi / totalPOSValue) * 100).toFixed(1) : 0;
        
        reportsKpiGrid.innerHTML = `
            <div class="kpi-card bg-white p-4 rounded-lg flex items-center"><div class="p-3 rounded-full bg-blue-100"><i data-lucide="banknote" class="w-6 h-6 text-blue-600"></i></div><div class="ml-3"><p class="text-sm font-medium text-gray-500">Total POS</p><p class="text-xl font-bold text-gray-900">₹${totalPOSValue.toLocaleString('en-IN')}</p></div></div>
            <div class="kpi-card bg-white p-4 rounded-lg flex items-center"><div class="p-3 rounded-full bg-cyan-100"><i data-lucide="landmark" class="w-6 h-6 text-cyan-600"></i></div><div class="ml-3"><p class="text-sm font-medium text-gray-500">Total Settled</p><p class="text-xl font-bold text-gray-900">₹${totalSettled.toLocaleString('en-IN')}</p></div></div>
            <div class="kpi-card bg-white p-4 rounded-lg flex items-center"><div class="p-3 rounded-full bg-orange-100"><i data-lucide="wallet" class="w-6 h-6 text-orange-600"></i></div><div class="ml-3"><p class="text-sm font-medium text-gray-500">Expenses</p><p class="text-xl font-bold text-gray-900">₹${totalExpenses.toLocaleString('en-IN')}</p></div></div>
            <div class="kpi-card bg-white p-4 rounded-lg flex items-center"><div class="p-3 rounded-full ${overallDifference < 0 ? 'bg-red-100' : 'bg-green-100'}"><i data-lucide="arrow-left-right" class="w-6 h-6 ${overallDifference < 0 ? 'text-red-600' : 'text-green-600'}"></i></div><div class="ml-3"><p class="text-sm font-medium text-gray-500">Overall Diff</p><p class="text-xl font-bold ${overallDifference < 0 ? 'text-red-600' : 'text-green-600'}">₹${overallDifference.toLocaleString('en-IN')}</p></div></div>
            <div class="kpi-card bg-white p-4 rounded-lg flex items-center"><div class="p-3 rounded-full bg-indigo-100"><i data-lucide="pie-chart" class="w-6 h-6 text-indigo-600"></i></div><div class="ml-3"><p class="text-sm font-medium text-gray-500">Payment Split</p><div class="text-xs font-bold flex gap-2"><span class="text-blue-600">Card ${cardPerc}%</span><span class="text-green-600">Cash ${cashPerc}%</span><span class="text-purple-600">UPI ${upiPerc}%</span></div></div></div>
        `;
        lucide.createIcons();

        // Table Head
        const totals = { posCash: sum('posCash'), depositedCash: sum('depositedCash'), expenses: sum('expenses'), cashDiff: sum('cashDiff'), posCard: sum('posCard'), cardSettled: sum('cardSettled'), cardDiff: sum('cardDiff'), posUpi: sum('posUpi'), upiSettled: sum('upiSettled'), upiDiff: sum('upiDiff'), overallDiff: sum('overallDiff') };
        reportsTableHead.innerHTML = `
            <tr class="font-bold text-blue-800 bg-blue-50">
                <td class="px-6 py-4 text-center text-sm">TOTALS</td><td class="px-6 py-4 text-center text-sm">-</td>
                <td class="px-6 py-4 text-center text-sm">₹${totals.posCash.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm">₹${totals.depositedCash.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm">₹${totals.expenses.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm font-semibold ${totals.cashDiff >= 0 ? 'text-green-600' : 'text-red-600'}">₹${totals.cashDiff.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm">₹${totals.posCard.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm">₹${totals.cardSettled.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm font-semibold ${totals.cardDiff >= 0 ? 'text-green-600' : 'text-red-600'}">₹${totals.cardDiff.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm">₹${totals.posUpi.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm">₹${totals.upiSettled.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm font-semibold ${totals.upiDiff >= 0 ? 'text-green-600' : 'text-red-600'}">₹${totals.upiDiff.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm font-bold ${totals.overallDiff >= 0 ? 'text-green-600' : 'text-red-600'}">₹${totals.overallDiff.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm">-</td>
            </tr>
            <tr>${["Store", "Date", "POS Cash", "Deposited Cash", "Expenses", "Cash Diff", "POS Card", "Card Settled", "Card Diff", "POS UPI", "UPI Settled", "UPI Diff", "Overall Diff", "Remarks"].map(h => `<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}</tr>
        `;
        
        renderReportsTablePage();
    }

    function renderReportsTablePage() {
        const totalPages = Math.ceil(reportsFilteredData.length / ITEMS_PER_PAGE);
        const startIndex = (reportsCurrentPage - 1) * ITEMS_PER_PAGE;
        const paginated = reportsFilteredData.slice(startIndex, startIndex + ITEMS_PER_PAGE);
        
        reportsTableBody.innerHTML = paginated.map(d => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 text-center text-sm text-gray-600 whitespace-nowrap">${d.store}</td>
                <td class="px-6 py-4 text-center text-sm font-medium text-gray-900 whitespace-nowrap">${formatDate(d.date)}</td>
                <td class="px-6 py-4 text-center text-sm text-gray-600">₹${d.posCash.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm text-gray-600">₹${d.depositedCash.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm text-gray-600">₹${d.expenses.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm font-semibold ${d.cashDiff >= 0 ? 'text-green-600' : 'text-red-600'}">₹${d.cashDiff.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm text-gray-600">₹${d.posCard.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm text-gray-600">₹${d.cardSettled.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm font-semibold ${d.cardDiff >= 0 ? 'text-green-600' : 'text-red-600'}">₹${d.cardDiff.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm text-gray-600">₹${d.posUpi.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm text-gray-600">₹${d.upiSettled.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-sm font-semibold ${d.upiDiff >= 0 ? 'text-green-600' : 'text-red-600'}">₹${d.upiDiff.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-center text-lg font-bold ${d.overallDiff >= 0 ? 'text-green-600' : 'text-red-600'}">₹${d.overallDiff.toLocaleString('en-IN')}</td>
                <td class="px-6 py-4 text-sm text-gray-600 whitespace-nowrap max-w-xs truncate" title="${d.remarks || ''}">${d.remarks || '-'}</td>
            </tr>
        `).join('');
        
        if (totalPages > 1) {
            reportsPagination.classList.remove('hidden');
            reportsPagination.innerHTML = `
                <button id="prev-page" ${reportsCurrentPage === 1 ? 'disabled' : ''} class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Previous</button>
                <span class="text-sm text-gray-700">Page ${reportsCurrentPage} of ${totalPages}</span>
                <button id="next-page" ${reportsCurrentPage === totalPages ? 'disabled' : ''} class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">Next<i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i></button>
            `;
            document.getElementById('prev-page').onclick = () => { reportsCurrentPage--; renderReportsTablePage(); };
            document.getElementById('next-page').onclick = () => { reportsCurrentPage++; renderReportsTablePage(); };
            lucide.createIcons();
        } else {
            reportsPagination.classList.add('hidden');
        }
    }

    function downloadCSV() {
        if (!reportsFilteredData.length) { alert("No data to download."); return; }
        const headers = ["store","date","posCash","depositedCash","expenses","cashDiff","posCard","cardSettled","cardDiff","posUpi","upiSettled","upiDiff","overallDiff","remarks"];
        const rows = reportsFilteredData.map(d => headers.map(h => `"${String(d[h] || '').replace(/"/g, '""')}"`).join(",")).join("\n");
        const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows;
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", `sales_report_${reportsFromDate.value}_to_${reportsToDate.value}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // =========== DASHBOARD PAGE LOGIC ===========
    function handleDashboardSearch() {
        const filtered = getFilteredData('dashboard');
        if (filtered) {
            if (filtered.length === 0) {
                alert("No data available for the selected criteria to generate charts.");
                dashboardInitialMsg.style.display = 'flex';
                dashboardChartsContainer.classList.add('hidden');
            } else {
                dashboardInitialMsg.style.display = 'none';
                dashboardChartsContainer.classList.remove('hidden');
                renderDashboard(filtered);
            }
        }
    }

    function renderDashboard(data) {
        const sum = (key) => data.reduce((s, d) => s + (d[key] || 0), 0);
        
        // KPIs
        const totalPOSValue = sum('posCash') + sum('posCard') + sum('posUpi');
        const overallDifference = sum('overallDiff');
        const totalExpenses = sum('expenses');
        const numDays = new Set(data.map(d => d.date)).size || 1;
        const avgDailySales = totalPOSValue / numDays;
        
        dashboardKpiGrid.innerHTML = `
            <div class="kpi-card bg-white p-5 rounded-lg flex items-center"><div class="p-3 rounded-full bg-blue-100 flex-shrink-0"><i data-lucide="banknote" class="w-6 h-6 text-blue-600"></i></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">Total POS Value</p><p class="text-2xl font-bold text-blue-600">₹${totalPOSValue.toLocaleString('en-IN')}</p></div></div>
            <div class="kpi-card bg-white p-5 rounded-lg flex items-center"><div class="p-3 rounded-full ${overallDifference < 0 ? 'bg-red-100' : 'bg-green-100'} flex-shrink-0"><i data-lucide="arrow-left-right" class="w-6 h-6 ${overallDifference < 0 ? 'text-red-600' : 'text-green-600'}"></i></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">Overall Difference</p><p class="text-2xl font-bold ${overallDifference < 0 ? 'text-red-600' : 'text-green-600'}">₹${overallDifference.toLocaleString('en-IN')}</p></div></div>
            <div class="kpi-card bg-white p-5 rounded-lg flex items-center"><div class="p-3 rounded-full bg-orange-100 flex-shrink-0"><i data-lucide="wallet" class="w-6 h-6 text-orange-600"></i></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">Total Expenses</p><p class="text-2xl font-bold text-orange-600">₹${totalExpenses.toLocaleString('en-IN')}</p></div></div>
            <div class="kpi-card bg-white p-5 rounded-lg flex items-center"><div class="p-3 rounded-full bg-purple-100 flex-shrink-0"><i data-lucide="calendar-check" class="w-6 h-6 text-purple-600"></i></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">Avg. Daily Sales</p><p class="text-2xl font-bold text-purple-600">₹${Math.round(avgDailySales).toLocaleString('en-IN')}</p></div></div>
        `;
        lucide.createIcons();

        // Charts
        const createChart = (name, canvasId, config) => {
            if (chartInstances[name]) chartInstances[name].destroy();
            const ctx = document.getElementById(canvasId).getContext('2d');
            chartInstances[name] = new Chart(ctx, config);
        };
        
        createChart('payment', 'payment-chart', {
            type: 'doughnut', data: { labels: ['Card', 'Cash', 'UPI'], datasets: [{ data: [sum('posCard'), sum('posCash'), sum('posUpi')], backgroundColor: ['#2563eb', '#10b981', '#8b5cf6'] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });

        const diffData = [sum('cashDiff'), sum('cardDiff'), sum('upiDiff')];
        createChart('difference', 'difference-chart', {
            type: 'bar', data: { labels: ['Cash Diff', 'Card Diff', 'UPI Diff'], datasets: [{ data: diffData, backgroundColor: diffData.map(v => v < 0 ? '#ef4444' : '#10b981') }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false } } }
        });
        
        const salesByDate = data.reduce((acc, item) => {
            const dateKey = formatDate(item.date);
            if (!acc[dateKey]) acc[dateKey] = 0;
            acc[dateKey] += item.posCash + item.posCard + item.posUpi;
            return acc;
        }, {});
        const trendLabels = Object.keys(salesByDate).sort((a, b) => parseSheetDate(a).getTime() - parseSheetDate(b).getTime());

        createChart('salesTrend', 'sales-trend-chart', {
            type: 'line', data: { labels: trendLabels, datasets: [{ label: 'Total POS Value', data: trendLabels.map(l => salesByDate[l]), borderColor: '#1d4ed8', backgroundColor: 'rgba(29, 78, 216, 0.1)', tension: 0.2, fill: true }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });

        const billsByDate = data.reduce((acc, item) => {
            const dateKey = formatDate(item.date);
            acc[dateKey] = (acc[dateKey] || 0) + (item.billCount || 0);
            return acc;
        }, {});
        const billsLabels = Object.keys(billsByDate).sort((a, b) => parseSheetDate(a).getTime() - parseSheetDate(b).getTime());
        
        createChart('bills', 'bills-chart', {
            type: 'bar', data: { labels: billsLabels, datasets: [{ label: 'No. of Bills', data: billsLabels.map(l => billsByDate[l]), backgroundColor: '#2563eb', borderRadius: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } }, x: { grid: { display: false } } } }
        });
    }

    // =========== EVENT LISTENERS ===========
    function addEventListeners() {
        navigation.addEventListener('click', e => {
            e.preventDefault();
            const link = e.target.closest('.nav-link');
            if (link && link.dataset.page) {
                switchPage(link.dataset.page);
            }
        });
        
        menuButton.addEventListener('click', () => sidebarWrapper.classList.add('is-open'));
        sidebarOverlay.addEventListener('click', () => sidebarWrapper.classList.remove('is-open'));
        sidebarCloseButton.addEventListener('click', () => sidebarWrapper.classList.remove('is-open'));

        // Reports Listeners
        reportsLocationBtn.addEventListener('click', () => reportsLocationDropdown.classList.toggle('hidden'));
        reportsLocationDropdown.addEventListener('change', () => updateLocationButtonText('reports'));
        reportsSearchBtn.addEventListener('click', handleReportsSearch);
        reportsDownloadBtn.addEventListener('click', downloadCSV);

        // Dashboard Listeners
        dashboardLocationBtn.addEventListener('click', () => dashboardLocationDropdown.classList.toggle('hidden'));
        dashboardLocationDropdown.addEventListener('change', () => updateLocationButtonText('dashboard'));
        dashboardSearchBtn.addEventListener('click', handleDashboardSearch);

        // Global click listener to close dropdowns
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#reports-location-filter-container')) reportsLocationDropdown.classList.add('hidden');
            if (!e.target.closest('#dashboard-location-filter-container')) dashboardLocationDropdown.classList.add('hidden');
        });
    }

    // =========== START APP ===========
    initializeApp();
});
</script>

</body>
</html>
